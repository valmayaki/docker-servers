# Development Environment - All dev tools with databases
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml --profile dev up -d

x-dns: &dns
  dns:
    - 172.20.0.53

x-common-env: &common-env
  POSTGRES_USER: root
  POSTGRES_PASSWORD: secret
  POSTGRES_DB: freedb
  MYSQL_ROOT_PASSWORD: secret
  MYSQL_DATABASE: freedb

services:
  # Core Development Stack
  nodejs:
    image: node-ffmpeg
    build:
      context: node
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - DEBUG=*
    profiles: ["dev"]

  mysql:
    image: mysql:8
    build:
      context: mysql
      dockerfile: Dockerfile
    environment:
      <<: *common-env
    volumes:
      - ./mysql/data:/var/lib/mysql
    ports:
      - "33069:3306"
    restart: unless-stopped
    profiles: ["dev"]

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    profiles: ["dev"]

  pgsql:
    image: postgres:16
    container_name: pgsql
    restart: unless-stopped
    environment:
      <<: *common-env
    build:
      context: pgsql
      dockerfile: Dockerfile
    volumes:
      - ./pgsql/data:/var/lib/postgresql/data
    ports:
      - "54320:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d freedb"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["dev"]

  # Development Tools
  pgadmin:
    image: dpage/pgadmin4
    container_name: PgAdmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-secret}
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "5011:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - default
      - pgsql
    links:
      - pgsql:pgsql-server
    profiles: ["dev"]

  image-registry:
    image: registry:2
    restart: unless-stopped
    ports:
      - "5200:5000"
    volumes:
      - image-registry-data:/var/lib/registry
    profiles: ["dev"]

  # Development Proxy (Caddy for simplicity)
  proxy-caddy:
    image: lucaslorentz/caddy-docker-proxy:ci-alpine
    ports:
      - "80:80"
      - "443:443"
    labels:
      - "caddy=(tls_docker_snippet)"
      - "caddy.tls=/etc/ssl/certs/custom/docker.crt.pem /etc/ssl/private/custom/docker.key.pem"
    environment:
      - CADDY_INGRESS_NETWORKS=caddy
    networks:
      - caddy
      - default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/docker.crt.pem:/etc/ssl/certs/custom/docker.crt.pem
      - ./certs/docker.key.pem:/etc/ssl/private/custom/docker.key.pem
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    profiles: ["dev"]

networks:
  caddy:
  default: {}
  dnsmasq:
  firefly_iii:
    driver: bridge
  mynet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  n8n_network:
  nginx-proxy:
  ollama:
  pgsql:
  pgvector:
  pihole:
  redis:
  traefik:

volumes:
  caddy_data:
  caddy_config:
  image-registry-data:
  pgadmin-data:
  pgsql-data:
  redis-data: